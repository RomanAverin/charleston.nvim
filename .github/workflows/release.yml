name: Create Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # Matches v1.4.0, v2.0.0, etc. (stable releases only)

jobs:
  validate-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for changelog generation

      - name: Extract version from tag
        id: tag_version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Tag: $TAG"
          echo "üìå Version: $VERSION"

      - name: Extract version from code
        id: code_version
        run: |
          CODE_VERSION=$(grep -oP 'M\.version = "\K[^"]+' lua/charleston/init.lua)
          echo "version=$CODE_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Code version: $CODE_VERSION"

      - name: Validate version match
        run: |
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          CODE_VERSION="${{ steps.code_version.outputs.version }}"

          echo "Comparing versions:"
          echo "  Tag version:  $TAG_VERSION"
          echo "  Code version: $CODE_VERSION"

          if [ "$TAG_VERSION" != "$CODE_VERSION" ]; then
            echo "‚ùå ERROR: Version mismatch!"
            echo "Git tag version ($TAG_VERSION) does not match code version ($CODE_VERSION)"
            echo "Please update lua/charleston/init.lua to version $TAG_VERSION before creating this tag"
            exit 1
          fi

          echo "‚úÖ Version validation passed"

      - name: Create extras archive
        run: |
          cd extras
          zip -r ../charleston-extras-${{ steps.tag_version.outputs.tag }}.zip .
          cd ..
          echo "üì¶ Created charleston-extras-${{ steps.tag_version.outputs.tag }}.zip"
          ls -lh charleston-extras-*.zip

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ steps.tag_version.outputs.tag }}^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "üìù First release - no previous tag found"
            CHANGELOG="First release of Charleston colorscheme"
          else
            echo "üìù Generating changelog from $PREV_TAG to ${{ steps.tag_version.outputs.tag }}"

            # Get feat, hl and fix commits
            FEATURES=$(git log $PREV_TAG..${{ steps.tag_version.outputs.tag }} --pretty=format:"%s (%h)" --reverse --grep="^feat\|^hl" --regexp-ignore-case)
            FIXES=$(git log $PREV_TAG..${{ steps.tag_version.outputs.tag }} --pretty=format:"%s (%h)" --reverse --grep="^fix" --regexp-ignore-case)

            # Build changelog
            CHANGELOG=""

            if [ -n "$FEATURES" ]; then
              CHANGELOG+="## Features"
              CHANGELOG+=$'\n'
              while IFS= read -r line; do
                # Remove "feat:", "feat(scope):", "hl:", or "hl(scope):" prefix
                CLEAN_LINE=$(echo "$line" | sed -E 's/^(feat|hl)(\([^)]+\))?:\s*//')
                CHANGELOG+="- $CLEAN_LINE"
                CHANGELOG+=$'\n'
              done <<< "$FEATURES"
              CHANGELOG+=$'\n'
            fi

            if [ -n "$FIXES" ]; then
              CHANGELOG+="## Fixes"
              CHANGELOG+=$'\n'
              while IFS= read -r line; do
                # Remove "fix:" or "fix(scope):" prefix
                CLEAN_LINE=$(echo "$line" | sed -E 's/^fix(\([^)]+\))?:\s*//')
                CHANGELOG+="- $CLEAN_LINE"
                CHANGELOG+=$'\n'
              done <<< "$FIXES"
            fi

            # If no feat/hl or fix commits found, show a note
            if [ -z "$FEATURES" ] && [ -z "$FIXES" ]; then
              CHANGELOG="No notable changes (no feat, hl or fix commits found)"
            fi
          fi

          # Save changelog to output (multiline)
          {
            echo 'body<<EOF'
            echo "$CHANGELOG"
            echo EOF
          } >> $GITHUB_OUTPUT

          echo "Generated changelog:"
          echo "$CHANGELOG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_version.outputs.tag }}
          name: ${{ steps.tag_version.outputs.tag }}
          body: ${{ steps.changelog.outputs.body }}
          draft: true
          prerelease: false
          files: |
            charleston-extras-${{ steps.tag_version.outputs.tag }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## üéâ Draft Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.tag_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.tag_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Draft (ready for review)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Release Assets:" >> $GITHUB_STEP_SUMMARY
          echo "- Source code (zip)" >> $GITHUB_STEP_SUMMARY
          echo "- Source code (tar.gz)" >> $GITHUB_STEP_SUMMARY
          echo "- charleston-extras-${{ steps.tag_version.outputs.tag }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úèÔ∏è Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and edit release notes if needed" >> $GITHUB_STEP_SUMMARY
          echo "2. Publish the release when ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View Draft Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag_version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
